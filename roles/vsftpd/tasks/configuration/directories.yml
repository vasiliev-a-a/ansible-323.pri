---
- name: "directories: Creating drop-in configuration directory (/etc/vsftpd.conf.d/)"
  become: yes
  ansible.builtin.file:
    path: "/etc/vsftpd.conf.d"
    state: directory
    mode: "0750"

- name: "directories: Creating FTP root ({{ ftp_root }})"
  become: yes
  ansible.builtin.file:
    path: "{{ ftp_root }}"
    state: directory
    mode: "0750"
    owner: root
    group: "{{ ftp_group['name'] }}"

- name: "directories: Creating per `ftp_users` chroot directory ({{ ftp_root }}/$USER) "
  become: yes
  ansible.builtin.file:
    path: "{{ ftp_root }}/{{ item['name'] }}"
    state: directory
    mode: "2770"
    owner: "{{ item['name']}}"
    group: "{{ item['name']}}"
  loop: "{{ ftp_users | selectattr('role','equalto','user') }}"

- name: "directories: Forcing Chroot and SFTP for members of `{{ ftp_group['name'] }}`"
  become: yes
  ansible.builtin.blockinfile:
    block: |
      Match User {{ ftp_users | map(attribute='name') | join(',') }}
      ChrootDirectory {{ ftp_root }}
      ForceCommand internal-sftp -d /%u
      AllowTcpForwarding no
      AllowAgentForwarding no
      X11Forwarding no
      PermitTunnel no
    marker: "# {mark} ANSIBLE MANAGED BLOCK: role=vsftpd"
    insertafter: EOF
    path: "/etc/ssh/sshd_config"
  notify: "services: Reloading OpenSSH Server service"
...
